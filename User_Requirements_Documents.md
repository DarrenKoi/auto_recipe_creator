# Recipe Setup 자동화 프로젝트 URD
## User Requirement Document

| 항목 | 내용 |
|------|------|
| 문서 버전 | v1.0 |
| 작성일 | 2025-01-18 |
| 작성자 | AI/DT TF Solution Team |
| 상태 | Draft |

---

## 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [시스템 요구사항](#2-시스템-요구사항)
3. [시스템 아키텍처](#3-시스템-아키텍처)
4. [데이터 요구사항](#4-데이터-요구사항)
5. [테스트 계획](#5-테스트-계획)
6. [프로젝트 계획](#6-프로젝트-계획)
7. [리스크 및 대응](#7-리스크-및-대응)
8. [다음 단계](#8-다음-단계-즉시-액션)

---

## 1. 프로젝트 개요

### 1.1 배경

SK hynix 기반기술센터에서 **CD-SEM**과 **VeritySEM** 장비를 운영하고 있음. 두 장비 모두 **e-beam 기반 metrology용 SEM 장비**로, 반도체 공정에서 **CD(Critical Dimension) 측정**에 사용됨.

현재 Recipe 셋업 작업은 엔지니어가 RCS(Remote Control System)를 통해 수동으로 수행하고 있으며, 이 과정은 반복적인 마우스/키보드 조작과 측정 결과 확인이 필요함. 특히 측정 위치를 잡는 과정에서 시행착오를 통한 조정이 빈번하게 발생함.

### 1.2 목표

VLM(Vision Language Model)과 GUI 자동화 기술을 활용하여 CD-SEM 및 VeritySEM의 Recipe 셋업 작업을 자동화하고, 엔지니어의 개입이 필요한 경우 실시간으로 협업할 수 있는 시스템 구축.

### 1.3 범위

| 구분 | 포함 | 제외 (1차) |
|------|------|----------|
| **장비** | CD-SEM, VeritySEM | AFM (추후 확장 고려) |
| **작업** | Recipe 셋업, CD 측정 위치 조정 | 장비 유지보수, 하드웨어 제어 |
| **환경** | Windows Host → VM → RCS | VM 내부 직접 설치 (보안 제약) |

### 1.4 대상 장비 개요

| 장비 | 용도 | 측정 방식 |
|------|------|----------|
| **CD-SEM** | Critical Dimension 측정 | e-beam based SEM |
| **VeritySEM** | Critical Dimension 측정 | e-beam based SEM |

---

## 2. 시스템 요구사항

### 2.1 기능 요구사항

| ID | 요구사항 | 우선순위 | 비고 |
|----|----------|----------|------|
| **FR-01** | VM 창 화면 캡처 및 실시간 모니터링 | 필수 | mss 라이브러리 활용 |
| **FR-02** | VLM 기반 화면 상태 인식 | 필수 | Qwen3-VL API 활용 |
| **FR-03** | 마우스/키보드 입력 자동화 | 필수 | pynput 활용 |
| **FR-04** | 측정 결과 자동 판단 (성공/실패) | 필수 | 규칙 + VLM 하이브리드 |
| **FR-05** | 실패 시 자동 위치/파라미터 조정 | 필수 | 적응형 조정 알고리즘 |
| **FR-06** | 워크플로우 정의 및 실행 | 필수 | 상태 머신 기반 |
| **FR-07** | 이미지 임베딩 기반 빠른 상태 매칭 | 높음 | CLIP + FAISS |
| **FR-08** | CCTV 영상에서 워크플로우 추출 | 높음 | 오프라인 분석 |
| **FR-09** | 엔지니어 실시간 개입 (수동 모드 전환) | 필수 | Supervised Autonomy |
| **FR-10** | AI-엔지니어 채팅 인터페이스 | 높음 | 프롬프트 기반 협업 |
| **FR-11** | 작업 로그 및 히스토리 저장 | 높음 | MongoDB |
| **FR-12** | 엔지니어 피드백 학습 | 보통 | 패턴 분석 → 규칙 개선 |

### 2.2 비기능 요구사항

| ID | 요구사항 | 목표치 | 측정 방법 |
|----|----------|--------|----------|
| **NFR-01** | 단일 액션 실행 속도 | < 200ms (VLM 미사용 시) | 타임스탬프 로깅 |
| **NFR-02** | 상태 매칭 정확도 | > 90% | 테스트셋 평가 |
| **NFR-03** | 측정 결과 판단 정확도 | > 85% | 엔지니어 검증 |
| **NFR-04** | Recipe 셋업 성공률 | > 70% (1차), > 90% (최종) | 실제 작업 통계 |
| **NFR-05** | 시스템 가용성 | 업무 시간 99% | 모니터링 |
| **NFR-06** | 최대 자동 시도 횟수 | 10회 후 사람에게 전달 | 설정 값 |

### 2.3 제약사항

| 제약 | 설명 | 대응 방안 |
|------|------|----------|
| VM 내부 API 호출 불가 | 보안 정책으로 외부 통신 차단 | Host에서 이미지 기반 제어 |
| VLM Fine-tuning 금지 | 회사 정책 | RAG, 규칙 기반, 프롬프트 엔지니어링 |
| GPU 없는 자동화 PC | 전용 PC에 GPU 미탑재 | H200 클러스터 활용 (무거운 작업) |

---

## 3. 시스템 아키텍처

### 3.1 전체 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           H200 클러스터                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • CCTV 영상 대량 분석                                           │   │
│  │  • 상태 임베딩 배치 생성                                          │   │
│  │  • VLM 추론 서버 (Qwen3-VL API)                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↕ API
┌─────────────────────────────────────────────────────────────────────────┐
│                         자동화 전용 PC                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────────┐    │
│  │ VM 클라이언트 │  │ 자동화 Agent │  │        데이터 저장소        │    │
│  │              │  │              │  │                            │    │
│  │  ┌────────┐  │  │ • 화면 캡처  │  │  • MongoDB (워크플로우)     │    │
│  │  │  RCS   │  │  │ • 상태 매칭  │  │  • FAISS (상태 임베딩)      │    │
│  │  │        │  │  │ • 액션 실행  │  │  • 로그 저장               │    │
│  │  └────────┘  │  │ • 채팅 처리  │  │                            │    │
│  └──────────────┘  └──────────────┘  └────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↕ WebSocket
┌─────────────────────────────────────────────────────────────────────────┐
│                      엔지니어 인터페이스 (Vue)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐      │
│  │  화면 미러링  │  │   AI 채팅    │  │       제어 패널          │      │
│  └──────────────┘  └──────────────┘  └──────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 컴포넌트 상세

| 컴포넌트 | 기술 스택 | 역할 |
|----------|----------|------|
| 화면 캡처 | mss | VM 창 고속 캡처 (~10ms) |
| 상태 매칭 | CLIP + FAISS | 이미지 임베딩 기반 빠른 매칭 |
| VLM 판단 | Qwen3-VL API | 복잡한 상황 분석, 예외 처리 |
| GUI 제어 | pynput | 마우스/키보드 입력 |
| 워크플로우 엔진 | Python (상태 머신) | 작업 시퀀스 관리 |
| 데이터 저장 | MongoDB | 워크플로우, 로그, 피드백 |
| 임베딩 인덱스 | FAISS | 상태 이미지 벡터 검색 |
| 프론트엔드 | Vue 3 + Tauri/Quasar | 엔지니어 UI |
| 백엔드 API | FastAPI + WebSocket | 실시간 통신 |

### 3.3 제어 모드

시스템은 Tesla FSD와 유사한 **Supervised Autonomy** 개념을 적용하여 다음 모드를 지원함:

| 모드 | 설명 | AI 동작 | 사람 동작 |
|------|------|---------|----------|
| **AUTO** | AI 전체 제어 | 자동 실행 | 모니터링만 |
| **SUPERVISED** | AI 제어 + 사람 감독 | 자동 실행 | 언제든 개입 가능 |
| **MANUAL** | 사람 직접 제어 | 대기 | 마우스/키보드 직접 조작 |
| **PAUSED** | 일시 정지 | 대기 | 재개 결정 |

---

## 4. 데이터 요구사항

### 4.1 수집 필요 데이터

| 데이터 | 형식 | 수량 (목표) | 용도 | 수집 방법 |
|--------|------|-------------|------|----------|
| **RCS 화면 스크린샷** | PNG/JPG | 500+ 장 | 상태 임베딩, 테스트 | 수동 캡처 + 자동 수집 |
| **CCTV 작업 영상** | AVI | 20+ 개 | 워크플로우 추출 | 기존 녹화본 |
| **화면 상태 레이블** | JSON | 100+ 종류 | 상태 분류 | 엔지니어 라벨링 |
| **측정 결과 샘플** | PNG + 메타데이터 | 200+ 건 | 판단 모델 평가 | 실제 작업 중 수집 |
| **워크플로우 정의** | JSON/YAML | 10+ 개 | 자동화 실행 | 엔지니어 인터뷰 |

### 4.2 데이터 스키마

#### 화면 상태 정의

```json
{
  "state_id": "main_menu",
  "state_name": "메인 메뉴",
  "description": "RCS 초기 화면, 장비 목록 접근 가능",
  "ui_elements": [
    {"name": "장비목록 버튼", "rel_x": 0.1, "rel_y": 0.3, "type": "button"},
    {"name": "검색창", "rel_x": 0.5, "rel_y": 0.1, "type": "input"}
  ],
  "transitions": {
    "click:장비목록 버튼": "equipment_list",
    "click:설정 메뉴": "settings"
  },
  "sample_images": ["main_menu_001.png", "main_menu_002.png"]
}
```

#### 워크플로우 정의

```json
{
  "workflow_id": "recipe_setup_cd",
  "name": "CD 측정 Recipe 셋업",
  "equipment_type": "CD-SEM",
  "steps": [
    {
      "step_id": 1,
      "action": "navigate",
      "target_state": "equipment_list",
      "timeout_seconds": 5
    },
    {
      "step_id": 2,
      "action": "search_equipment",
      "params": {"equipment_id": "${EQUIPMENT_ID}"}
    },
    {
      "step_id": 3,
      "action": "open_recipe_editor",
      "expected_state": "recipe_editor"
    },
    {
      "step_id": 4,
      "action": "measurement_loop",
      "max_attempts": 10,
      "success_criteria": {"type": "measurement_valid"}
    }
  ]
}
```

#### 측정 결과 기록

```json
{
  "measurement_id": "meas_20250118_001",
  "timestamp": "2025-01-18T14:30:00",
  "equipment_id": "CD-SEM-042",
  "point_id": "point_3",
  "attempt": 2,
  "screenshot": "meas_20250118_001.png",
  "auto_judgment": {
    "success": false,
    "confidence": 0.72,
    "failure_reason": "position_offset",
    "suggested_adjustment": {"direction": "left", "amount": "small"}
  },
  "human_override": {
    "applied": true,
    "action": {"direction": "left", "pixels": 8},
    "final_result": "success"
  }
}
```

---

## 5. 테스트 계획

### 5.1 테스트 단계

| Phase | 테스트 유형 | 주요 검증 항목 |
|-------|------------|---------------|
| **Phase 1** | 단위 테스트 | 화면 캡처 정확도, VLM API 연동, 마우스/키보드 입력 전달, 상태 매칭 정확도 |
| **Phase 2** | 통합 테스트 | 단일 워크플로우 End-to-End, 에러 복구 시나리오, 모드 전환 (Auto ↔ Manual), 채팅 인터페이스 연동 |
| **Phase 3** | 파일럿 테스트 | 실제 장비 1대로 Recipe 셋업, 엔지니어 참관 하에 실행, 피드백 수집 및 개선 |
| **Phase 4** | 확장 테스트 | 다양한 Recipe 유형, 여러 장비 대상, 장시간 안정성 테스트 |

### 5.2 테스트 케이스

| TC ID | 테스트 항목 | 입력 | 기대 결과 | 통과 기준 |
|-------|------------|------|----------|----------|
| **TC-01** | VM 창 캡처 | VM 창 활성화 | 정확한 화면 이미지 | 해상도 일치, 지연 < 50ms |
| **TC-02** | 상태 매칭 (정상) | 메인 메뉴 화면 | "main_menu" 반환 | confidence > 0.85 |
| **TC-03** | 상태 매칭 (미등록) | 새로운 팝업 | "unknown" + 후보 목록 | VLM 폴백 동작 |
| **TC-04** | 클릭 전달 | 좌표 (100, 200) | VM 내 해당 위치 클릭 | 정확도 ± 5px |
| **TC-05** | 측정 성공 판단 | 정상 측정 화면 | success: true | 정확도 > 90% |
| **TC-06** | 측정 실패 판단 | 에러 화면 | success: false + 원인 | 정확도 > 85% |
| **TC-07** | 자동 위치 조정 | 실패 + 방향 힌트 | 올바른 방향 이동 | 수렴 시도 < 5회 |
| **TC-08** | 워크플로우 실행 | 전체 Recipe 셋업 | 모든 포인트 완료 | 성공률 > 70% |
| **TC-09** | 수동 모드 전환 | 사용자 클릭 | 즉시 모드 전환 | 지연 < 100ms |
| **TC-10** | AI 채팅 응답 | "이 화면 뭐야?" | 상황 분석 응답 | 관련성 있는 답변 |
| **TC-11** | 최대 시도 초과 | 10회 실패 | 사람에게 알림 | 정확히 10회 후 중단 |
| **TC-12** | 피드백 기록 | 사람 개입 후 성공 | DB에 기록 | 모든 필드 저장 |

### 5.3 평가 지표

| 지표 | 계산 방법 | 목표 (Phase별) |
|------|----------|---------------|
| **상태 매칭 정확도** | 정확 매칭 / 전체 테스트 | P1: 80%, P2: 90%, P4: 95% |
| **측정 판단 정확도** | 정확 판단 / 전체 측정 | P1: 75%, P2: 85%, P4: 90% |
| **Recipe 셋업 성공률** | 자동 완료 / 전체 시도 | P3: 50%, P4: 70%, 최종: 90% |
| **평균 시도 횟수** | 총 시도 / 성공 케이스 | 목표 < 3회 |
| **사람 개입 비율** | 개입 필요 / 전체 작업 | 목표 < 20% |
| **작업 시간 단축률** | (수동 시간 - 자동 시간) / 수동 시간 | 목표 > 50% |

---

## 6. 프로젝트 계획

### 6.1 마일스톤

| 마일스톤 | 목표 시기 | 내용 |
|----------|----------|------|
| **M1: PoC** | Q1 | 환경 구축, 기본 기능 검증 |
| **M2: Alpha** | Q2 | 핵심 기능 완성, 통합 테스트 |
| **M3: Beta** | Q3 | 파일럿 테스트, 피드백 반영 |
| **M4: 배포** | Q4 | 확장 및 안정화 |

### 6.2 상세 일정

#### Phase 1: 환경 구축 (1-4주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 1주 | 자동화 PC 세팅, 라이브러리 설치 | 개발 환경 |
| 2주 | VM 창 캡처 + 입력 전달 테스트 | TC-01, TC-04 통과 |
| 3주 | Qwen3-VL API 연동 | VLM 호출 파이프라인 |
| 4주 | 기본 데이터 수집 (스크린샷 100장) | 초기 데이터셋 |

#### Phase 2: 핵심 기능 (5-10주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 5-6주 | 상태 매칭 시스템 (CLIP + FAISS) | TC-02, TC-03 통과 |
| 7-8주 | 측정 결과 판단 로직 | TC-05, TC-06 통과 |
| 9-10주 | 워크플로우 엔진 | TC-08 통과 |

#### Phase 3: UI 개발 (11-14주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 11-12주 | Vue 프론트엔드 (화면 미러링, 제어) | TC-09 통과 |
| 13-14주 | AI 채팅 인터페이스 | TC-10 통과 |

#### Phase 4: 통합 & 파일럿 (15-20주)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 15-16주 | 통합 테스트 | 전체 TC 통과 |
| 17-18주 | 파일럿 (장비 1대) | 실사용 피드백 |
| 19-20주 | 개선 및 안정화 | v1.0 릴리즈 |

#### Phase 5: 확장 (21주~)

| 주차 | 작업 | 산출물 |
|------|------|--------|
| 21-24주 | CCTV 영상 분석 파이프라인 | 워크플로우 자동 추출 |
| 25주~ | 다중 장비 확장 | 스케일업 |

### 6.3 리소스 계획

| 리소스 | 용도 | 확보 상태 |
|--------|------|----------|
| **자동화 전용 PC** | 자동화 Agent 실행 | 요청 예정 |
| **H200 클러스터 접근** | VLM 추론, 영상 분석 | 확보됨 |
| **Qwen3-VL API** | 화면 분석 | 확보됨 (회사 제공) |
| **MongoDB 서버** | 데이터 저장 | 구축 필요 |
| **테스트 장비 (CD-SEM, VeritySEM)** | 파일럿 테스트 | 협의 필요 |
| **CCTV 영상 접근** | 워크플로우 추출 | 협의 필요 |

---

## 7. 리스크 및 대응

| 리스크 | 발생 확률 | 영향도 | 대응 방안 |
|--------|----------|--------|----------|
| VM 창 캡처 품질 저하 | 중 | 높음 | 해상도/스케일 보정 로직 |
| VLM 판단 정확도 미달 | 중 | 높음 | 규칙 기반 보완, 프롬프트 개선 |
| RCS UI 변경 | 낮음 | 높음 | 상태 재학습 프로세스 구축 |
| 보안팀 협조 지연 | 중 | 중 | 대안 아키텍처 준비 |
| 엔지니어 수용성 낮음 | 중 | 중 | 초기 참여, 피드백 반영 |

---

## 8. 다음 단계 (즉시 액션)

| 순서 | 작업 | 담당 | 기한 |
|------|------|------|------|
| 1 | 자동화 전용 PC 요청 | TBD | 1주차 |
| 2 | RCS 화면 스크린샷 50장 수집 | TBD | 2주차 |
| 3 | VM 창 캡처 + 클릭 전달 PoC | TBD | 2주차 |
| 4 | Qwen3-VL API 연동 테스트 | TBD | 3주차 |
| 5 | 화면 상태 10종 정의 및 라벨링 | TBD | 4주차 |
| 6 | CCTV 영상 샘플 확보 협의 | TBD | 4주차 |

---

## 부록

### A. 용어 정의

| 용어 | 정의 |
|------|------|
| **CD-SEM** | Critical Dimension Scanning Electron Microscope, e-beam 기반 CD 측정 장비 |
| **VeritySEM** | e-beam 기반 metrology용 SEM 장비, CD 측정에 사용 |
| **RCS** | Remote Control System, 원격 장비 제어 시스템 |
| **Recipe** | 측정 장비의 동작 설정 및 측정 위치 정보 |
| **VLM** | Vision Language Model, 이미지와 텍스트를 함께 이해하는 AI 모델 |
| **Supervised Autonomy** | AI가 주도하되 사람이 언제든 개입 가능한 제어 방식 |

### B. 참고 문서

- Qwen3-VL API 문서
- CLIP 모델 사용 가이드
- FAISS 인덱싱 가이드
- Vue 3 + Tauri 개발 가이드

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| v1.0 | 2025-01-18 | 최초 작성 | AI/DT TF Solution Team |
